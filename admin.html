<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <title>å¤œé£Ÿå–ã‚Šç½®ã ç®¡ç†ç”»é¢</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    body {
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      background: #f5f5f5;
      margin: 0;
      padding: 16px;
      color: #111;
    }

    h1 {
      font-size: 20px;
      margin-bottom: 8px;
    }

    .sub {
      font-size: 12px;
      color: #666;
      margin-bottom: 16px;
    }

    .toolbar {
      display: flex;
      gap: 8px;
      align-items: center;
      margin-bottom: 12px;
    }

    button {
      cursor: pointer;
    }

    .reload-btn {
      padding: 6px 12px;
      border-radius: 999px;
      border: 1px solid #ccc;
      background: #fff;
      font-size: 12px;
    }

    .status-filter-btn {
      padding: 6px 10px;
      border-radius: 999px;
      border: 1px solid #ddd;
      background: #fff;
      font-size: 12px;
    }

    .status-filter-btn.active {
      background: #111;
      color: #fff;
      border-color: #111;
    }

    table {
      width: 100%;
      border-collapse: collapse;
      font-size: 12px;
      background: #fff;
      border-radius: 12px;
      overflow: hidden;
      box-shadow: 0 1px 4px rgba(0,0,0,0.06);
    }

    thead {
      background: #f3f3f3;
    }

    th, td {
      padding: 8px 6px;
      border-bottom: 1px solid #eee;
      vertical-align: top;
    }

    th {
      text-align: left;
      font-weight: 600;
      font-size: 12px;
      color: #555;
    }

    tr:last-child td {
      border-bottom: none;
    }

    .order-id {
      font-family: monospace;
      font-size: 11px;
    }

    .items-list {
      list-style: none;
      padding-left: 0;
      margin: 0;
    }

    .items-list li {
      margin-bottom: 2px;
    }

    .status-select {
      font-size: 12px;
      padding: 4px 6px;
      border-radius: 6px;
    }

    .status-badge {
      display: inline-block;
      padding: 2px 6px;
      border-radius: 999px;
      font-size: 11px;
      margin-top: 2px;
    }

    .status-new {
      background: #fff3cd;
      color: #856404;
    }

    .status-preparing {
      background: #cce5ff;
      color: #004085;
    }

    .status-ready {
      background: #d4edda;
      color: #155724;
    }

    .status-done {
      background: #e2e3e5;
      color: #383d41;
    }

    .no-data {
      padding: 16px;
      font-size: 13px;
      color: #666;
      text-align: center;
    }
  </style>
</head>
<body>
  <h1>å¤œé£Ÿå–ã‚Šç½®ã ç®¡ç†ç”»é¢</h1>
  <div class="sub">ãƒ­ãƒ¼ã‚½ãƒ³å—éƒ¨ã®é‡Œåº— / Firestore: orders ä¸€è¦§</div>

  <div class="toolbar">
    <button id="reloadBtn" class="reload-btn">ğŸ”„ æ›´æ–°</button>

    <span style="font-size:12px;">ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹çµã‚Šè¾¼ã¿ï¼š</span>
    <button class="status-filter-btn active" data-status="all">ã™ã¹ã¦</button>
    <button class="status-filter-btn" data-status="new">new</button>
    <button class="status-filter-btn" data-status="preparing">preparing</button>
    <button class="status-filter-btn" data-status="ready">ready</button>
    <button class="status-filter-btn" data-status="done">done</button>
  </div>

  <div id="tableWrap"></div>

  <script type="module">
  // ================= Firebase èª­ã¿è¾¼ã¿ =================
  import { initializeApp } from "https://www.gstatic.com/firebasejs/11.0.0/firebase-app.js";
  import {
    getFirestore,
    collection,
    getDocs,
    doc,         // â˜…è¿½åŠ 
    updateDoc    // â˜…è¿½åŠ 
  } from "https://www.gstatic.com/firebasejs/11.0.0/firebase-firestore.js";


// ==================== ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹æ›´æ–° ====================
async function updateStatus(orderId, newStatus) {
  try {
    const orderRef = doc(db, "orders", orderId);
    await updateDoc(orderRef, {
      status: newStatus
    });
    console.log("ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹æ›´æ–°:", orderId, newStatus);
  } catch (err) {
    console.error("ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹æ›´æ–°ã‚¨ãƒ©ãƒ¼:", err);
    alert("ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ã®æ›´æ–°ã«å¤±æ•—ã—ã¾ã—ãŸã€‚");
  }
}





    
    const firebaseConfig = {
      apiKey: "AIzaSyDYJrgcp9nhyNn2ZR-DMIn1C_Lk_Em6lZo",
      authDomain: "myshop-nanbu.firebaseapp.com",
      projectId: "myshop-nanbu",
      storageBucket: "myshop-nanbu.firebasestorage.app",
      messagingSenderId: "122308310474",
      appId: "1:122308310474:web:44c10cd3709feb5eb14b33",
      measurementId: "G-0WLVED7GQF"
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);

    const tableWrap = document.getElementById("tableWrap");
    const reloadBtn = document.getElementById("reloadBtn");
    const filterButtons = document.querySelectorAll(".status-filter-btn");

    let allOrders = [];
    let currentFilter = "all";

    // ========== æ³¨æ–‡ã®èª­ã¿è¾¼ã¿ ==========
    async function loadOrders() {
      tableWrap.innerHTML = "<div class='no-data'>èª­ã¿è¾¼ã¿ä¸­...</div>";

      try {
        const q = query(
          collection(db, "orders"),
          orderBy("createdAt", "desc")
        );
        const snap = await getDocs(q);

        allOrders = snap.docs.map(docSnap => {
          const data = docSnap.data();
          return {
            id: docSnap.id,
            ...data
          };
        });

        renderTable();
      } catch (err) {
        console.error("orders èª­ã¿è¾¼ã¿ã‚¨ãƒ©ãƒ¼:", err);
        tableWrap.innerHTML = "<div class='no-data'>èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸã€‚</div>";
      }
    }

    // ========== ãƒ†ãƒ¼ãƒ–ãƒ«æç”» ==========
    function renderTable() {
      const filtered = allOrders.filter(order => {
        if (currentFilter === "all") return true;
        return order.status === currentFilter;
      });

      if (filtered.length === 0) {
        tableWrap.innerHTML = "<div class='no-data'>æ³¨æ–‡ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Šã¾ã›ã‚“ã€‚</div>";
        return;
      }

      const rowsHtml = filtered.map(order => {
        const created = order.createdAt?.toDate
          ? order.createdAt.toDate()
          : null;
        const dateStr = created
          ? `${created.getMonth() + 1}/${created.getDate()} ${String(created.getHours()).padStart(2,"0")}:${String(created.getMinutes()).padStart(2,"0")}`
          : "-";

        const itemsHtml = (order.items || []).map(it => {
          return `<li>${it.name} Ã— ${it.qty}ï¼ˆÂ¥${it.price}ï¼‰</li>`;
        }).join("");

        const total = order.total ?? 0;

        const statusBadgeClass =
          order.status === "new" ? "status-new" :
          order.status === "preparing" ? "status-preparing" :
          order.status === "ready" ? "status-ready" :
          order.status === "done" ? "status-done" : "";

        return `
          <tr data-id="${order.id}">
            <td>
              <div>${dateStr}</div>
              <div class="order-id">${order.id}</div>
            </td>
            <td>
              ${order.customerName || "-"}<br>
              <span style="font-size:11px;color:#666;">${order.tel || ""}</span>
            </td>
            <td>${order.pickupTime || "-"}</td>
            <td>
              <ul class="items-list">
                ${itemsHtml}
              </ul>
            </td>
            <td>Â¥${total}</td>
            <td>
              <select class="status-select">
                <option value="new" ${order.status === "new" ? "selected" : ""}>new</option>
                <option value="preparing" ${order.status === "preparing" ? "selected" : ""}>preparing</option>
                <option value="ready" ${order.status === "ready" ? "selected" : ""}>ready</option>
                <option value="done" ${order.status === "done" ? "selected" : ""}>done</option>
              </select>
              <div class="status-badge ${statusBadgeClass}">
                ${order.status || "-"}
              </div>
            </td>
          </tr>
        `;
      }).join("");

      tableWrap.innerHTML = `
        <table>
          <thead>
            <tr>
              <th>æ™‚é–“ / æ³¨æ–‡ID</th>
              <th>ãŠå®¢æ§˜</th>
              <th>å—ã‘å–ã‚Šæ™‚é–“</th>
              <th>å†…å®¹</th>
              <th>åˆè¨ˆ</th>
              <th>ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹</th>
            </tr>
          </thead>
          <tbody>
            ${rowsHtml}
          </tbody>
        </table>
      `;

      // ã‚»ãƒ¬ã‚¯ãƒˆã«ã‚¤ãƒ™ãƒ³ãƒˆã‚’ä»˜ã‘ã‚‹
      tableWrap.querySelectorAll(".status-select").forEach(select => {
        select.addEventListener("change", async () => {
          const tr = select.closest("tr");
          const id = tr.dataset.id;
          const newStatus = select.value;

          try {
  // â˜…ã“ã“ã ã‘æ›¸ãæ›ãˆã‚‹
  await updateStatus(id, newStatus);


            // ãƒ¡ãƒ¢ãƒªä¸Šã®ãƒ‡ãƒ¼ã‚¿ã‚‚æ›´æ–°
            const target = allOrders.find(o => o.id === id);
            if (target) target.status = newStatus;

            // ãƒãƒƒã‚¸ã®è¡¨ç¤ºæ›´æ–°
            const badge = tr.querySelector(".status-badge");
            badge.textContent = newStatus;
            badge.className = "status-badge " +
              (newStatus === "new" ? "status-new" :
               newStatus === "preparing" ? "status-preparing" :
               newStatus === "ready" ? "status-ready" :
               newStatus === "done" ? "status-done" : "");

          } catch (err) {
            console.error("ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹æ›´æ–°ã‚¨ãƒ©ãƒ¼:", err);
            alert("ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ã®æ›´æ–°ã«å¤±æ•—ã—ã¾ã—ãŸã€‚");
          }
        });
      });
    }

    // ========== ã‚¤ãƒ™ãƒ³ãƒˆ ==========
    reloadBtn.addEventListener("click", loadOrders);

    filterButtons.forEach(btn => {
      btn.addEventListener("click", () => {
        filterButtons.forEach(b => b.classList.remove("active"));
        btn.classList.add("active");
        currentFilter = btn.dataset.status;
        renderTable();
      });
    });

    // åˆå›èª­ã¿è¾¼ã¿
    loadOrders();
  </script>
</body>
</html>

<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <title>å¤œé£Ÿå–ã‚Šç½®ã ç®¡ç†ç”»é¢</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    * { box-sizing: border-box; }

    body {
      margin: 0;
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      background: #f5f5f5;
      color: #111;
    }

    /* ========= ãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆå…¨ä½“ï¼ˆTimeeé¢¨ï¼‰ ========= */
    .layout {
      display: flex;
      min-height: 100vh;
    }

    /* å·¦ã‚µã‚¤ãƒ‰ãƒãƒ¼ */
    .sidebar {
      width: 220px;
      background: #ffffff;
      border-right: 1px solid #e5e5e5;
      padding: 16px 0 24px;
      display: flex;
      flex-direction: column;
      gap: 8px;
    }

    .sidebar-header {
      padding: 0 20px 8px;
      border-bottom: 1px solid #f0f0f0;
      margin-bottom: 8px;
    }

    .sidebar-title {
      font-size: 14px;
      font-weight: 600;
    }

    .sidebar-sub {
      font-size: 11px;
      color: #777;
    }

    .sidebar-nav {
      list-style: none;
      padding: 0;
      margin: 0;
    }

    .sidebar-nav li { margin-bottom: 2px; }

    .sidebar-link {
      display: block;
      padding: 8px 20px;
      font-size: 13px;
      color: #444;
      text-decoration: none;
      border-left: 3px solid transparent;
    }

    .sidebar-link.active {
      background: #f5f7ff;
      border-left-color: #2f54eb;
      color: #2f54eb;
      font-weight: 600;
    }

    /* ãƒ¡ã‚¤ãƒ³ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ */
    .main {
      flex: 1;
      padding: 24px 32px;
      overflow-x: auto;
    }

    .page-header { margin-bottom: 16px; }

    .page-title {
      font-size: 20px;
      font-weight: 600;
      margin-bottom: 4px;
    }

    .page-subtitle {
      font-size: 12px;
      color: #777;
    }

    /* ã‚¿ãƒ–ï¼ˆæ³¨æ–‡ä¸€è¦§ / å•†å“ãƒã‚¹ã‚¿ï¼‰ */
    .nav-tabs {
      display: inline-flex;
      gap: 4px;
      padding: 4px;
      background: #ffffff;
      border-radius: 999px;
      border: 1px solid #e5e5e5;
      margin-bottom: 16px;
    }

    .nav-tab {
      padding: 6px 14px;
      border-radius: 999px;
      border: none;
      background: transparent;
      font-size: 12px;
      cursor: pointer;
      color: #555;
    }

    .nav-tab.active {
      background: #111;
      color: #fff;
    }

    /* ãƒ„ãƒ¼ãƒ«ãƒãƒ¼ */
    .toolbar {
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
      align-items: center;
      margin-bottom: 12px;
    }

    button { cursor: pointer; }

    .reload-btn {
      padding: 6px 12px;
      border-radius: 999px;
      border: 1px solid #ccc;
      background: #fff;
      font-size: 12px;
    }

    .status-filter-btn {
      padding: 6px 10px;
      border-radius: 999px;
      border: 1px solid #ddd;
      background: #fff;
      font-size: 12px;
    }

    .status-filter-btn.active {
      background: #111;
      color: #fff;
      border-color: #111;
    }

    /* ãƒ†ãƒ¼ãƒ–ãƒ«ï¼ˆTimee é¢¨ï¼‰ */
    table {
      width: 100%;
      border-collapse: collapse;
      font-size: 12px;
      background: #fff;
    }

    thead {
      background: #fafafa;
      border-bottom: 1px solid #eee;
    }

    th, td {
      padding: 10px 12px;
      vertical-align: middle;
      border-bottom: 1px solid #f0f0f0;
    }

    th {
      text-align: left;
      font-weight: 600;
      font-size: 12px;
      color: #555;
      white-space: nowrap;
    }

    tr:last-child td { border-bottom: none; }

    .table-card-wrap {
      border-radius: 12px;
      overflow: hidden;
      box-shadow: 0 1px 4px rgba(0,0,0,0.04);
      background: #fff;
    }

    .order-id {
      font-family: monospace;
      font-size: 11px;
      color: #888;
    }

    .items-list {
      list-style: none;
      padding-left: 0;
      margin: 0;
    }

    .items-list li { margin-bottom: 2px; }

    .status-select {
      font-size: 12px;
      padding: 4px 6px;
      border-radius: 6px;
      border: 1px solid #ddd;
      background: #fff;
    }

    .status-badge {
      display: inline-block;
      padding: 2px 6px;
      border-radius: 999px;
      font-size: 11px;
      margin-top: 4px;
    }

    .status-new       { background: #fff7e6; color: #ad6800; }
    .status-preparing { background: #e6f7ff; color: #0050b3; }
    .status-ready     { background: #f6ffed; color: #237804; }
    .status-done      { background: #f5f5f5; color: #595959; }

    .no-data {
      padding: 16px;
      font-size: 13px;
      color: #666;
      text-align: center;
      background: #fff;
      border-radius: 12px;
      box-shadow: 0 1px 4px rgba(0,0,0,0.04);
    }

    /* å•†å“ãƒã‚¹ã‚¿ç”¨ãƒ•ã‚©ãƒ¼ãƒ  */
    .item-form {
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
      margin-bottom: 12px;
      font-size: 12px;
    }

    .item-form input,
    .item-form select {
      padding: 6px 8px;
      font-size: 12px;
      border-radius: 6px;
      border: 1px solid #ccc;
      background: #fff;
    }

    .item-form button {
      padding: 6px 12px;
      border-radius: 999px;
      border: 1px solid #111;
      background: #111;
      color: #fff;
      font-size: 12px;
      cursor: pointer;
    }

    .item-small {
      font-size: 11px;
      color: #666;
      margin-bottom: 8px;
    }

    .danger-btn {
      padding: 4px 10px;
      border-radius: 999px;
      border: 1px solid #ff7875;
      background: #fff2f0;
      color: #a8071a;
      font-size: 11px;
      cursor: pointer;
    }

    .hidden { display: none; }

    .item-thumb {
      width: 60px;
      height: 60px;
      object-fit: cover;
      border-radius: 8px;
    }

    /* ã‚«ãƒ†ã‚´ãƒªç®¡ç†ãƒ‘ãƒãƒ« */
    .category-panel {
      margin-top: 24px;
      padding-top: 12px;
      border-top: 1px solid #eee;
    }
    .category-title {
      font-size: 13px;
      font-weight: 600;
      margin-bottom: 4px;
    }
    .category-note {
      font-size: 11px;
      color: #666;
      margin-bottom: 8px;
    }

    /* ã‚¹ãƒãƒ›æ™‚ã¯ã‚µã‚¤ãƒ‰ãƒãƒ¼ã‚’ä¸Šã«æŠ¼ã—ã¤ã¶ã™ */
    @media (max-width: 768px) {
      .layout {
        flex-direction: column;
      }
      .sidebar {
        width: 100%;
        border-right: none;
        border-bottom: 1px solid #eee;
      }
    }
  </style>
</head>
<body>
  <div class="layout">
    <!-- ===== å·¦ã‚µã‚¤ãƒ‰ãƒãƒ¼ ===== -->
    <aside class="sidebar">
      <div class="sidebar-header">
        <div class="sidebar-title">å¤œé£Ÿå–ã‚Šç½®ã ç®¡ç†</div>
        <div class="sidebar-sub">ãƒ­ãƒ¼ã‚½ãƒ³å—éƒ¨ã®é‡Œåº—</div>
      </div>
      <ul class="sidebar-nav">
        <li><span class="sidebar-link active">å–ã‚Šç½®ãç®¡ç†</span></li>
        <li><span class="sidebar-link">å£²ä¸Šãƒ¬ãƒãƒ¼ãƒˆï¼ˆå°†æ¥ï¼‰</span></li>
        <li><span class="sidebar-link">ã‚¹ã‚¿ãƒƒãƒ•ç®¡ç†ï¼ˆå°†æ¥ï¼‰</span></li>
      </ul>
    </aside>

    <!-- ===== ãƒ¡ã‚¤ãƒ³ã‚¨ãƒªã‚¢ ===== -->
    <main class="main">
      <div class="page-header">
        <div class="page-title">å–ã‚Šç½®ãç®¡ç†</div>
        <div class="page-subtitle">Firestore ä¸Šã®æ³¨æ–‡æƒ…å ±ã¨å•†å“ãƒã‚¹ã‚¿ã‚’ã¾ã¨ã‚ã¦ç®¡ç†</div>
      </div>

      <!-- ã‚¿ãƒ– -->
      <div class="nav-tabs">
        <button id="tabOrders" class="nav-tab active">æ³¨æ–‡ä¸€è¦§</button>
        <button id="tabItems" class="nav-tab">å•†å“ãƒã‚¹ã‚¿</button>
      </div>

      <!-- æ³¨æ–‡ã‚»ã‚¯ã‚·ãƒ§ãƒ³ -->
      <section id="ordersSection">
        <div class="toolbar">
          <button id="reloadBtn" class="reload-btn">ğŸ”„ æ›´æ–°</button>

          <span style="font-size:12px;">ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹çµã‚Šè¾¼ã¿ï¼š</span>
          <button class="status-filter-btn active" data-status="all">ã™ã¹ã¦</button>
          <button class="status-filter-btn" data-status="new">new</button>
          <button class="status-filter-btn" data-status="preparing">preparing</button>
          <button class="status-filter-btn" data-status="ready">ready</button>
          <button class="status-filter-btn" data-status="done">done</button>
        </div>

        <div class="table-card-wrap">
          <div id="tableWrap"></div>
        </div>
      </section>

      <!-- å•†å“ãƒã‚¹ã‚¿ã‚»ã‚¯ã‚·ãƒ§ãƒ³ -->
      <section id="itemsSection" class="hidden">
        <div class="toolbar">
          <span style="font-size:12px;">å•†å“ãƒã‚¹ã‚¿ï¼ˆFirestore: itemsï¼‰</span>
          <button id="reloadItemsBtn" class="reload-btn">ğŸ”„ æ›´æ–°</button>
        </div>

        <!-- å•†å“è¿½åŠ ãƒ•ã‚©ãƒ¼ãƒ  -->
        <form id="itemForm" class="item-form">
          <input id="itemNameInput" type="text" placeholder="å•†å“å ä¾‹ï¼‰ã‹ã‚‰ã‚ã’ã‚¯ãƒ³ ãƒ¬ã‚®ãƒ¥ãƒ©ãƒ¼" required />
          <input id="itemPriceInput" type="number" min="0" placeholder="ä¾¡æ ¼ ä¾‹ï¼‰240" required />
          <input id="itemImageInput" type="file" accept="image/*" />

          <select id="itemCategory1Select" required>
            <option value="">ã‚«ãƒ†ã‚´ãƒª1ï¼ˆå¤§ã‚¸ãƒ£ãƒ³ãƒ«ï¼‰</option>
          </select>

          <select id="itemCategory2Select">
            <option value="">ã‚«ãƒ†ã‚´ãƒª2ï¼ˆã‚µãƒ–ã‚¸ãƒ£ãƒ³ãƒ« / ä»»æ„ï¼‰</option>
          </select>

          <button type="submit">ï¼‹ å•†å“è¿½åŠ </button>
        </form>

        <div class="item-small">
          â€» ã‚«ãƒ†ã‚´ãƒª1ã¯å¿…é ˆã€‚ã‚«ãƒ†ã‚´ãƒª2ã¯ä»»æ„ã€‚ãƒ•ãƒ­ãƒ³ãƒˆå´ã®ãƒ¡ãƒ‹ãƒ¥ãƒ¼ã¯ã‚«ãƒ†ã‚´ãƒª1â†’ã‚«ãƒ†ã‚´ãƒª2ã®é †ã§ä¸¦ã¹ã‚‹æƒ³å®šã€‚
        </div>

        <div class="table-card-wrap">
          <div id="itemsTableWrap"></div>
        </div>

        <!-- ã‚«ãƒ†ã‚´ãƒªç®¡ç† -->
        <div class="category-panel">
          <div class="category-title">ã‚«ãƒ†ã‚´ãƒªç®¡ç†ï¼ˆFirestore: categoriesï¼‰</div>
          <div class="category-note">
            ãƒ»è¦ªãªã—ã§ç™»éŒ²ã™ã‚‹ã¨ã€Œã‚«ãƒ†ã‚´ãƒª1ã€ã«ãªã‚‹ã€‚<br/>
            ãƒ»è¦ªã‚’é¸ã‚“ã§ç™»éŒ²ã™ã‚‹ã¨ã€ãã®ä¸‹ã®ã€Œã‚«ãƒ†ã‚´ãƒª2ã€ã«ãªã‚‹ã‚¤ãƒ¡ãƒ¼ã‚¸ã€‚
          </div>
          <form id="categoryForm" class="item-form">
            <input id="categoryNameInput" type="text" placeholder="ã‚«ãƒ†ã‚´ãƒªå ä¾‹ï¼‰ç‚­é…¸ / ã‚³ãƒ¼ãƒ’ãƒ¼" required />
            <select id="categoryParentSelect">
              <option value="">è¦ªã‚«ãƒ†ã‚´ãƒªãªã—ï¼ˆã‚«ãƒ†ã‚´ãƒª1ï¼‰</option>
            </select>
            <button type="submit">ï¼‹ ã‚«ãƒ†ã‚´ãƒªè¿½åŠ </button>
          </form>
        </div>
      </section>
    </main>
  </div>

  <!-- ========= JavaScript ========= -->
  <script type="module">
    // ================= Firebase èª­ã¿è¾¼ã¿ =================
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.0.0/firebase-app.js";
    import {
      getFirestore,
      collection,
      getDocs,
      doc,
      updateDoc,
      addDoc,
      deleteDoc,
      query,
      orderBy
    } from "https://www.gstatic.com/firebasejs/11.0.0/firebase-firestore.js";

    import {
      getStorage,
      ref,
      uploadBytes,
      getDownloadURL,
      deleteObject
    } from "https://www.gstatic.com/firebasejs/11.0.0/firebase-storage.js";

    // ================= Firebase åˆæœŸåŒ– ====================
    const firebaseConfig = {
      apiKey: "AIzaSyDYJrgcp9nhyNn2ZR-DMIn1C_Lk_Em6lZo",
      authDomain: "myshop-nanbu.firebaseapp.com",
      projectId: "myshop-nanbu",
      storageBucket: "myshop-nanbu.firebasestorage.app",
      messagingSenderId: "122308310474",
      appId: "1:122308310474:web:44c10cd3709feb5eb14b33",
      measurementId: "G-0WLVED7GQF"
    };

    const app     = initializeApp(firebaseConfig);
    const db      = getFirestore(app);
    const storage = getStorage(app);

    // ================= DOM å‚ç…§ ==========================
    const tableWrap      = document.getElementById("tableWrap");
    const reloadBtn      = document.getElementById("reloadBtn");
    const filterButtons  = document.querySelectorAll(".status-filter-btn");

    const tabOrders      = document.getElementById("tabOrders");
    const tabItems       = document.getElementById("tabItems");
    const ordersSection  = document.getElementById("ordersSection");
    const itemsSection   = document.getElementById("itemsSection");

    // å•†å“ãƒã‚¹ã‚¿ç”¨
    const reloadItemsBtn     = document.getElementById("reloadItemsBtn");
    const itemsTableWrap     = document.getElementById("itemsTableWrap");
    const itemForm           = document.getElementById("itemForm");
    const itemNameInput      = document.getElementById("itemNameInput");
    const itemPriceInput     = document.getElementById("itemPriceInput");
    const itemImageInput     = document.getElementById("itemImageInput");
    const itemCategory1Select= document.getElementById("itemCategory1Select");
    const itemCategory2Select= document.getElementById("itemCategory2Select");

    // ã‚«ãƒ†ã‚´ãƒªç®¡ç†ç”¨
    const categoryForm        = document.getElementById("categoryForm");
    const categoryNameInput   = document.getElementById("categoryNameInput");
    const categoryParentSelect= document.getElementById("categoryParentSelect");

    // ================= çŠ¶æ…‹ =============================
    let allOrders      = [];
    let currentFilter  = "all";
    let allItems       = [];
    let allCategories  = [];

    // ==================== ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹æ›´æ–° ====================
    async function updateStatus(orderId, newStatus) {
      try {
        const orderRef = doc(db, "orders", orderId);
        await updateDoc(orderRef, { status: newStatus });
        console.log("ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹æ›´æ–°:", orderId, newStatus);
      } catch (err) {
        console.error("ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹æ›´æ–°ã‚¨ãƒ©ãƒ¼:", err);
        alert("ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ã®æ›´æ–°ã«å¤±æ•—ã—ã¾ã—ãŸã€‚");
      }
    }

    // ========== æ³¨æ–‡ã®èª­ã¿è¾¼ã¿ ==========
    async function loadOrders() {
      tableWrap.innerHTML = "<div class='no-data'>èª­ã¿è¾¼ã¿ä¸­...</div>";

      try {
        const q = query(
          collection(db, "orders"),
          orderBy("createdAt", "desc")
        );
        const snap = await getDocs(q);

        allOrders = snap.docs.map(docSnap => ({
          id: docSnap.id,
          ...docSnap.data()
        }));

        renderOrderTable();
      } catch (err) {
        console.error("orders èª­ã¿è¾¼ã¿ã‚¨ãƒ©ãƒ¼:", err);
        tableWrap.innerHTML = "<div class='no-data'>èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸã€‚</div>";
      }
    }

    // ========== æ³¨æ–‡ãƒ†ãƒ¼ãƒ–ãƒ«æç”» ==========
    function renderOrderTable() {
      const filtered = allOrders.filter(order => {
        if (currentFilter === "all") return true;
        return order.status === currentFilter;
      });

      if (filtered.length === 0) {
        tableWrap.innerHTML = "<div class='no-data'>æ³¨æ–‡ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Šã¾ã›ã‚“ã€‚</div>";
        return;
      }

      const rowsHtml = filtered.map(order => {
        const created = order.createdAt?.toDate
          ? order.createdAt.toDate()
          : null;
        const dateStr = created
          ? `${created.getMonth() + 1}/${created.getDate()} ${String(created.getHours()).padStart(2,"0")}:${String(created.getMinutes()).padStart(2,"0")}`
          : "-";

        const itemsHtml = (order.items || []).map(it =>
          `<li>${it.name} Ã— ${it.qty}ï¼ˆÂ¥${it.price}ï¼‰</li>`
        ).join("");

        const total = order.total ?? 0;

        const statusBadgeClass =
          order.status === "new"       ? "status-new" :
          order.status === "preparing" ? "status-preparing" :
          order.status === "ready"     ? "status-ready" :
          order.status === "done"      ? "status-done" : "";

        return `
          <tr data-id="${order.id}">
            <td>
              <div>${dateStr}</div>
              <div class="order-id">${order.id}</div>
            </td>
            <td>
              ${order.customerName || "-"}<br>
              <span style="font-size:11px;color:#666;">${order.tel || ""}</span>
            </td>
            <td>${order.pickupTime || "-"}</td>
            <td>
              <ul class="items-list">
                ${itemsHtml}
              </ul>
            </td>
            <td>Â¥${total}</td>
            <td>
              <select class="status-select">
                <option value="new"       ${order.status === "new"       ? "selected" : ""}>new</option>
                <option value="preparing" ${order.status === "preparing" ? "selected" : ""}>preparing</option>
                <option value="ready"     ${order.status === "ready"     ? "selected" : ""}>ready</option>
                <option value="done"      ${order.status === "done"      ? "selected" : ""}>done</option>
              </select>
              <div class="status-badge ${statusBadgeClass}">
                ${order.status || "-"}
              </div>
            </td>
          </tr>
        `;
      }).join("");

      tableWrap.innerHTML = `
        <table>
          <thead>
            <tr>
              <th>æ™‚é–“ / æ³¨æ–‡ID</th>
              <th>ãŠå®¢æ§˜</th>
              <th>å—ã‘å–ã‚Šæ™‚é–“</th>
              <th>å†…å®¹</th>
              <th>åˆè¨ˆ</th>
              <th>ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹</th>
            </tr>
          </thead>
          <tbody>
            ${rowsHtml}
          </tbody>
        </table>
      `;

      tableWrap.querySelectorAll(".status-select").forEach(select => {
        select.addEventListener("change", async () => {
          const tr = select.closest("tr");
          const id = tr.dataset.id;
          const newStatus = select.value;

          try {
            await updateStatus(id, newStatus);

            const target = allOrders.find(o => o.id === id);
            if (target) target.status = newStatus;

            const badge = tr.querySelector(".status-badge");
            badge.textContent = newStatus;
            badge.className = "status-badge " +
              (newStatus === "new"       ? "status-new" :
               newStatus === "preparing" ? "status-preparing" :
               newStatus === "ready"     ? "status-ready" :
               newStatus === "done"      ? "status-done" : "");
          } catch (err) {
            console.error("ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹æ›´æ–°ã‚¨ãƒ©ãƒ¼:", err);
            alert("ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ã®æ›´æ–°ã«å¤±æ•—ã—ã¾ã—ãŸã€‚");
          }
        });
      });
    }

    // ========== ã‚«ãƒ†ã‚´ãƒªèª­ã¿è¾¼ã¿ & ã‚»ãƒ¬ã‚¯ãƒˆåæ˜  ==========
    async function loadCategories() {
      try {
        const snap = await getDocs(collection(db, "categories"));
        allCategories = snap.docs.map(docSnap => ({
          id: docSnap.id,
          ...docSnap.data()
        }));
        renderCategorySelects();
      } catch (err) {
        console.error("categories èª­ã¿è¾¼ã¿ã‚¨ãƒ©ãƒ¼:", err);
      }
    }

    // ã‚«ãƒ†ã‚´ãƒª1ï¼ˆè¦ªãªã—ï¼‰ãƒªã‚¹ãƒˆã‚’ã‚»ãƒ¬ã‚¯ãƒˆã«åæ˜ 
function renderCategorySelects() {
  const topLevel = allCategories.filter(c => !c.parentId); // è¦ªãªã— = ã‚«ãƒ†ã‚´ãƒª1

  // è¦ªã‚»ãƒ¬ã‚¯ãƒˆï¼ˆã‚«ãƒ†ã‚´ãƒªè¿½åŠ ç”¨ï¼‰
  categoryParentSelect.innerHTML =
    `<option value="">è¦ªã‚«ãƒ†ã‚´ãƒªãªã—ï¼ˆã‚«ãƒ†ã‚´ãƒª1ï¼‰</option>` +
    topLevel.map(c => `<option value="${c.id}">${c.name}</option>`).join("");

  // å•†å“ãƒ•ã‚©ãƒ¼ãƒ ã®ã‚«ãƒ†ã‚´ãƒª1
  const currentValue = itemCategory1Select.value; // ã„ã¾é¸ã‚“ã§ã‚‹å€¤ã‚’ä¸€æ—¦ãƒ¡ãƒ¢
  itemCategory1Select.innerHTML =
    `<option value="">ã‚«ãƒ†ã‚´ãƒª1ï¼ˆå¤§ã‚¸ãƒ£ãƒ³ãƒ«ï¼‰</option>` +
    topLevel.map(c => `<option value="${c.id}">${c.name}</option>`).join("");

  // ã•ã£ãé¸ã‚“ã§ã„ãŸå€¤ãŒã‚ã‚Œã°å¾©å…ƒ
  if (currentValue) {
    itemCategory1Select.value = currentValue;
  }

  // ã‚«ãƒ†ã‚´ãƒª2å´ã‚‚æ›´æ–°
  renderCategory2Options();
}

// ã‚«ãƒ†ã‚´ãƒª1ã®é¸æŠã«å¿œã˜ã¦ã‚«ãƒ†ã‚´ãƒª2ã ã‘ã‚’æ›´æ–°
function renderCategory2Options() {
  const parentId = itemCategory1Select.value;
  const secondLevel = allCategories.filter(c => c.parentId === parentId);

  itemCategory2Select.innerHTML =
    `<option value="">ã‚«ãƒ†ã‚´ãƒª2ï¼ˆã‚µãƒ–ã‚¸ãƒ£ãƒ³ãƒ« / ä»»æ„ï¼‰</option>` +
    secondLevel.map(c => `<option value="${c.id}">${c.name}</option>`).join("");
}


    // ã‚«ãƒ†ã‚´ãƒª1å¤‰æ›´æ™‚ã¯ã€ã‚«ãƒ†ã‚´ãƒª2ã ã‘ä½œã‚Šç›´ã™
itemCategory1Select.addEventListener("change", renderCategory2Options);


    // ========== å•†å“ãƒã‚¹ã‚¿ï¼šèª­ã¿è¾¼ã¿ ==========
    async function loadItems() {
      itemsTableWrap.innerHTML = "<div class='no-data'>èª­ã¿è¾¼ã¿ä¸­...</div>";
      try {
        const snap = await getDocs(collection(db, "items"));
        allItems = snap.docs.map(docSnap => ({
          id: docSnap.id,
          ...docSnap.data()
        }));
        renderItemsTable();
      } catch (err) {
        console.error("items èª­ã¿è¾¼ã¿ã‚¨ãƒ©ãƒ¼:", err);
        itemsTableWrap.innerHTML = "<div class='no-data'>èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸã€‚</div>";
      }
    }

    // ========== å•†å“ãƒã‚¹ã‚¿ï¼šãƒ†ãƒ¼ãƒ–ãƒ«æç”» ==========
    function renderItemsTable() {
      if (!allItems.length) {
        itemsTableWrap.innerHTML = "<div class='no-data'>å•†å“ãŒç™»éŒ²ã•ã‚Œã¦ã„ã¾ã›ã‚“ã€‚</div>";
        return;
      }

      const rowsHtml = allItems.map(item => {
        const cat1Name = item.category1Name || "-";
        const cat2Name = item.category2Name || "";

        return `
          <tr data-id="${item.id}">
            <td>${item.name || "-"}</td>
            <td>
              ${
                item.imageUrl
                  ? `<img src="${item.imageUrl}" class="item-thumb" alt="${item.name}">`
                  : "-"
              }
            </td>
            <td>Â¥${(item.price ?? 0).toLocaleString()}</td>
            <td>${cat1Name}</td>
            <td>${cat2Name || "-"}</td>
            <td>
              <button type="button" class="danger-btn item-delete-btn" data-id="${item.id}">å‰Šé™¤</button>
            </td>
          </tr>
        `;
      }).join("");

      itemsTableWrap.innerHTML = `
        <table>
          <thead>
            <tr>
              <th>å•†å“å</th>
              <th>ç”»åƒ</th>
              <th>ä¾¡æ ¼</th>
              <th>ã‚«ãƒ†ã‚´ãƒª1</th>
              <th>ã‚«ãƒ†ã‚´ãƒª2</th>
              <th></th>
            </tr>
          </thead>
          <tbody>
            ${rowsHtml}
          </tbody>
        </table>
      `;

      itemsTableWrap.querySelectorAll(".item-delete-btn").forEach(btn => {
  btn.addEventListener("click", async (e) => {
    e.preventDefault();
    e.stopPropagation();

    const id = btn.dataset.id;
    if (!confirm("ã“ã®å•†å“ã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ")) return;

    try {
      // ç”»åƒãŒã‚ã‚‹å•†å“ã ã‘ Storage å‰Šé™¤ã‚’è©¦ã™
      const target = allItems.find(i => i.id === id);
      if (target && target.imageUrl) {
        const imgRef = ref(storage, `items/${id}`);
        await deleteObject(imgRef).catch(() => {});
      }

      // Firestore ã®ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆå‰Šé™¤
      await deleteDoc(doc(db, "items", id));

      // ãƒ­ãƒ¼ã‚«ãƒ«é…åˆ—ã‹ã‚‰ã‚‚å‰Šé™¤ã—ã¦å†æç”»
      allItems = allItems.filter(i => i.id !== id);
      renderItemsTable();
    } catch (err) {
      console.error("å•†å“å‰Šé™¤ã‚¨ãƒ©ãƒ¼:", err);
      alert("å•†å“ã®å‰Šé™¤ã«å¤±æ•—ã—ã¾ã—ãŸã€‚");
    }
  });
});

    }

    // ========== ã‚¤ãƒ™ãƒ³ãƒˆ ==========

    // æ³¨æ–‡å´
    reloadBtn.addEventListener("click", loadOrders);
    filterButtons.forEach(btn => {
      btn.addEventListener("click", () => {
        filterButtons.forEach(b => b.classList.remove("active"));
        btn.classList.add("active");
        currentFilter = btn.dataset.status;
        renderOrderTable();
      });
    });

    // ã‚¿ãƒ–åˆ‡ã‚Šæ›¿ãˆ
    tabOrders.addEventListener("click", () => {
      tabOrders.classList.add("active");
      tabItems.classList.remove("active");
      ordersSection.classList.remove("hidden");
      itemsSection.classList.add("hidden");
    });

    tabItems.addEventListener("click", () => {
      tabItems.classList.add("active");
      tabOrders.classList.remove("active");
      ordersSection.classList.add("hidden");
      itemsSection.classList.remove("hidden");
      // å•†å“ã‚¿ãƒ–é–‹ã„ãŸã‚¿ã‚¤ãƒŸãƒ³ã‚°ã§èª­ã¿è¾¼ã¿
      loadCategories();
      loadItems();
    });

    // å•†å“ãƒã‚¹ã‚¿ï¼šæ›´æ–°ãƒœã‚¿ãƒ³
    reloadItemsBtn.addEventListener("click", () => {
      loadCategories();
      loadItems();
    });

    // å•†å“è¿½åŠ ãƒ•ã‚©ãƒ¼ãƒ 
itemForm.addEventListener("submit", async (e) => {
  e.preventDefault();
  const name  = itemNameInput.value.trim();
  const price = Number(itemPriceInput.value);
  const file  = itemImageInput.files[0] || null;

  const category1Id = itemCategory1Select.value || null;
  const category2Id = itemCategory2Select.value || null;

  if (!name || !price || !category1Id) {
    alert("å•†å“åãƒ»ä¾¡æ ¼ãƒ»ã‚«ãƒ†ã‚´ãƒª1ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚");
    return;
  }

  const cat1 = allCategories.find(c => c.id === category1Id) || null;
  const cat2 = allCategories.find(c => c.id === category2Id) || null;

  try {
    // 1. Firestore ã«å•†å“ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆè¿½åŠ 
    const docRef = await addDoc(collection(db, "items"), {
      name,
      price,
      category1Id,
      category1Name: cat1?.name || "",
      category2Id,
      category2Name: cat2?.name || ""
    });

    // 2. ç”»åƒãŒã‚ã‚Œã° Storage ã«ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ â†’ URL ã‚’ä¿å­˜
    if (file) {
      const storageRef = ref(storage, `items/${docRef.id}`);
      await uploadBytes(storageRef, file);
      const url = await getDownloadURL(storageRef);
      await updateDoc(docRef, { imageUrl: url });
    }

    itemForm.reset();
    renderCategory2Options();
    loadItems();   // â† ã“ã‚Œã§ãƒ†ãƒ¼ãƒ–ãƒ«å†èª­ã¿è¾¼ã¿

  } catch (err) {
    console.error("å•†å“è¿½åŠ ã‚¨ãƒ©ãƒ¼:", err);
    alert("å•†å“ã®è¿½åŠ ã«å¤±æ•—ã—ã¾ã—ãŸã€‚");
  }
});


    // ã‚«ãƒ†ã‚´ãƒªè¿½åŠ ãƒ•ã‚©ãƒ¼ãƒ 
    categoryForm.addEventListener("submit", async (e) => {
      e.preventDefault();
      const name = categoryNameInput.value.trim();
      const parentId = categoryParentSelect.value || null;

      if (!name) {
        alert("ã‚«ãƒ†ã‚´ãƒªåã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚");
        return;
      }

      try {
        await addDoc(collection(db, "categories"), {
          name,
          parentId
        });
        categoryForm.reset();
        await loadCategories();
      } catch (err) {
        console.error("ã‚«ãƒ†ã‚´ãƒªè¿½åŠ ã‚¨ãƒ©ãƒ¼:", err);
        alert("ã‚«ãƒ†ã‚´ãƒªã®è¿½åŠ ã«å¤±æ•—ã—ã¾ã—ãŸã€‚");
      }
    });

    // åˆå›ï¼šæ³¨æ–‡ã ã‘èª­ã¿è¾¼ã¿ï¼ˆå•†å“ã‚¿ãƒ–ã‚’é–‹ã„ãŸã‚‰å•†å“ & ã‚«ãƒ†ã‚´ãƒªã‚’èª­ã¿è¾¼ã‚€ï¼‰
    loadOrders();
  </script>
</body>
</html>

<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <title>å¤œé£Ÿå–ã‚Šç½®ã ç®¡ç†ç”»é¢</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    body {
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      background: #f5f5f5;
      margin: 0;
      padding: 16px;
      color: #111;
    }

    h1 {
      font-size: 20px;
      margin-bottom: 8px;
    }

    .sub {
      font-size: 12px;
      color: #666;
      margin-bottom: 16px;
    }

    .toolbar {
      display: flex;
      gap: 8px;
      align-items: center;
      margin-bottom: 12px;
    }

    button {
      cursor: pointer;
    }

    .reload-btn {
      padding: 6px 12px;
      border-radius: 999px;
      border: 1px solid #ccc;
      background: #fff;
      font-size: 12px;
    }

    .status-filter-btn {
      padding: 6px 10px;
      border-radius: 999px;
      border: 1px solid #ddd;
      background: #fff;
      font-size: 12px;
    }

    .status-filter-btn.active {
      background: #111;
      color: #fff;
      border-color: #111;
    }

    table {
      width: 100%;
      border-collapse: collapse;
      font-size: 12px;
      background: #fff;
      border-radius: 12px;
      overflow: hidden;
      box-shadow: 0 1px 4px rgba(0,0,0,0.06);
    }

    thead {
      background: #f3f3f3;
    }

    th, td {
      padding: 8px 6px;
      border-bottom: 1px solid #eee;
      vertical-align: top;
    }

    th {
      text-align: left;
      font-weight: 600;
      font-size: 12px;
      color: #555;
    }

    tr:last-child td {
      border-bottom: none;
    }

    .order-id {
      font-family: monospace;
      font-size: 11px;
    }

    .items-list {
      list-style: none;
      padding-left: 0;
      margin: 0;
    }

    .items-list li {
      margin-bottom: 2px;
    }

    .status-select {
      font-size: 12px;
      padding: 4px 6px;
      border-radius: 6px;
    }

    .status-badge {
      display: inline-block;
      padding: 2px 6px;
      border-radius: 999px;
      font-size: 11px;
      margin-top: 2px;
    }

    .status-new {
      background: #fff3cd;
      color: #856404;
    }

    .status-preparing {
      background: #cce5ff;
      color: #004085;
    }

    .status-ready {
      background: #d4edda;
      color: #155724;
    }

    .status-done {
      background: #e2e3e5;
      color: #383d41;
    }

    .no-data {
      padding: 16px;
      font-size: 13px;
      color: #666;
      text-align: center;
    }




    .nav-tabs {
      display: flex;
      gap: 8px;
      margin-bottom: 8px;
    }
    .nav-tab {
      padding: 6px 12px;
      border-radius: 999px;
      border: 1px solid #ddd;
      background: #fff;
      font-size: 12px;
      cursor: pointer;
    }
    .nav-tab.active {
      background: #111;
      color: #fff;
      border-color: #111;
    }

    .hidden {
      display: none;
    }

    .item-form {
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
      margin-bottom: 12px;
      font-size: 12px;
    }
    .item-form input,
    .item-form select {
      padding: 6px 8px;
      font-size: 12px;
      border-radius: 6px;
      border: 1px solid #ccc;
    }
    .item-form button {
      padding: 6px 10px;
      border-radius: 999px;
      border: 1px solid #111;
      background: #111;
      color: #fff;
      font-size: 12px;
      cursor: pointer;
    }
    .item-small {
      font-size: 11px;
      color: #666;
    }
    .danger-btn {
      padding: 4px 8px;
      border-radius: 999px;
      border: 1px solid #e55353;
      background: #ffe5e5;
      color: #a00;
      font-size: 11px;
      cursor: pointer;
    }








    
  </style>
</head>
<body>
    <h1>å¤œé£Ÿå–ã‚Šç½®ã ç®¡ç†ç”»é¢</h1>
  <div class="sub">ãƒ­ãƒ¼ã‚½ãƒ³å—éƒ¨ã®é‡Œåº— / Firestore ç®¡ç†</div>

  <!-- ğŸ”½ ã‚¿ãƒ– -->
  <div class="nav-tabs">
    <button id="tabOrders" class="nav-tab active">æ³¨æ–‡ä¸€è¦§</button>
    <button id="tabItems" class="nav-tab">å•†å“ãƒã‚¹ã‚¿</button>
  </div>

  <!-- ğŸ”½ æ³¨æ–‡ã‚»ã‚¯ã‚·ãƒ§ãƒ³ -->
  <section id="ordersSection">
    <div class="toolbar">
      <button id="reloadBtn" class="reload-btn">ğŸ”„ æ›´æ–°</button>

      <span style="font-size:12px;">ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹çµã‚Šè¾¼ã¿ï¼š</span>
      <button class="status-filter-btn active" data-status="all">ã™ã¹ã¦</button>
      <button class="status-filter-btn" data-status="new">new</button>
      <button class="status-filter-btn" data-status="preparing">preparing</button>
      <button class="status-filter-btn" data-status="ready">ready</button>
      <button class="status-filter-btn" data-status="done">done</button>
    </div>

    <div id="tableWrap"></div>
  </section>

  <!-- ğŸ”½ å•†å“ãƒã‚¹ã‚¿ã‚»ã‚¯ã‚·ãƒ§ãƒ³ -->
  <section id="itemsSection" class="hidden">
    <div class="toolbar">
      <span style="font-size:12px;">å•†å“ãƒã‚¹ã‚¿ï¼ˆFirestore: itemsï¼‰</span>
      <button id="reloadItemsBtn" class="reload-btn">ğŸ”„ æ›´æ–°</button>
    </div>

    <!-- è¿½åŠ ãƒ•ã‚©ãƒ¼ãƒ  -->
    <form id="itemForm" class="item-form">
      <input id="itemNameInput" type="text" placeholder="å•†å“å ä¾‹ï¼‰ã‹ã‚‰ã‚ã’ã‚¯ãƒ³ ãƒ¬ã‚®ãƒ¥ãƒ©ãƒ¼" required />
      <input id="itemPriceInput" type="number" min="0" step="10" placeholder="ä¾¡æ ¼ ä¾‹ï¼‰240" required />
      <select id="itemCategorySelect" required>
        <option value="">ã‚«ãƒ†ã‚´ãƒª</option>
        <option value="hotsnack">ãƒ›ãƒƒãƒˆã‚¹ãƒŠãƒƒã‚¯</option>
        <option value="drink">é£²æ–™</option>
        <option value="bread">ãƒ‘ãƒ³</option>
        <option value="limited">å–ã‚Šç½®ãé™å®š</option>
      </select>
      <button type="submit">ï¼‹ å•†å“è¿½åŠ </button>
    </form>

    <div class="item-small">â€» ã“ã“ã§è¿½åŠ ã—ãŸå•†å“ãŒã€ãƒ•ãƒ­ãƒ³ãƒˆå´ã®ãƒ¡ãƒ‹ãƒ¥ãƒ¼ã«åæ˜ ã•ã‚Œã‚‹æƒ³å®šã€‚</div>
    <br />
    <div id="itemsTableWrap"></div>
  </section>


    <script type="module">
  // ================= Firebase èª­ã¿è¾¼ã¿ =================
  import { initializeApp } from "https://www.gstatic.com/firebasejs/11.0.0/firebase-app.js";
  import {
    getFirestore,
    collection,
    getDocs,
    doc,
    updateDoc,
    addDoc,
    deleteDoc,
    query,
    orderBy
  } from "https://www.gstatic.com/firebasejs/11.0.0/firebase-firestore.js";

  // ================= Firebase åˆæœŸåŒ– ====================
  const firebaseConfig = {
    apiKey: "AIzaSyDYJrgcp9nhyNn2ZR-DMIn1C_Lk_Em6lZo",
    authDomain: "myshop-nanbu.firebaseapp.com",
    projectId: "myshop-nanbu",
    storageBucket: "myshop-nanbu.firebasestorage.app",
    messagingSenderId: "122308310474",
    appId: "1:122308310474:web:44c10cd3709feb5eb14b33",
    measurementId: "G-0WLVED7GQF"
  };

  const app = initializeApp(firebaseConfig);
  const db  = getFirestore(app);

  // ================= DOM å‚ç…§ ==========================
  const tableWrap      = document.getElementById("tableWrap");
  const reloadBtn      = document.getElementById("reloadBtn");
  const filterButtons  = document.querySelectorAll(".status-filter-btn");

  // ã‚¿ãƒ–é–¢é€£
  const tabOrders      = document.getElementById("tabOrders");
  const tabItems       = document.getElementById("tabItems");
  const ordersSection  = document.getElementById("ordersSection");
  const itemsSection   = document.getElementById("itemsSection");

  // å•†å“ãƒã‚¹ã‚¿ç”¨
  const reloadItemsBtn     = document.getElementById("reloadItemsBtn");
  const itemsTableWrap     = document.getElementById("itemsTableWrap");
  const itemForm           = document.getElementById("itemForm");
  const itemNameInput      = document.getElementById("itemNameInput");
  const itemPriceInput     = document.getElementById("itemPriceInput");
  const itemCategorySelect = document.getElementById("itemCategorySelect");

  // ================= çŠ¶æ…‹ï¼ˆãƒ¡ãƒ¢ãƒªä¸Šã®ãƒ‡ãƒ¼ã‚¿ï¼‰ ============
  let allOrders = [];
  let currentFilter = "all";

  let allItems = []; // å•†å“ãƒã‚¹ã‚¿

  // ==================== ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹æ›´æ–° ====================
  async function updateStatus(orderId, newStatus) {
    try {
      const orderRef = doc(db, "orders", orderId);
      await updateDoc(orderRef, {
        status: newStatus
      });
      console.log("ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹æ›´æ–°:", orderId, newStatus);
    } catch (err) {
      console.error("ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹æ›´æ–°ã‚¨ãƒ©ãƒ¼:", err);
      alert("ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ã®æ›´æ–°ã«å¤±æ•—ã—ã¾ã—ãŸã€‚");
    }
  }

  // ========== æ³¨æ–‡ã®èª­ã¿è¾¼ã¿ ==========
  async function loadOrders() {
    tableWrap.innerHTML = "<div class='no-data'>èª­ã¿è¾¼ã¿ä¸­...</div>";

    try {
      const q = query(
        collection(db, "orders"),
        orderBy("createdAt", "desc")
      );
      const snap = await getDocs(q);

      allOrders = snap.docs.map(docSnap => ({
        id: docSnap.id,
        ...docSnap.data()
      }));

      renderTable();
    } catch (err) {
      console.error("orders èª­ã¿è¾¼ã¿ã‚¨ãƒ©ãƒ¼:", err);
      tableWrap.innerHTML = "<div class='no-data'>èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸã€‚</div>";
    }
  }

  // ========== æ³¨æ–‡ãƒ†ãƒ¼ãƒ–ãƒ«æç”» ==========
  function renderTable() {
    const filtered = allOrders.filter(order => {
      if (currentFilter === "all") return true;
      return order.status === currentFilter;
    });

    if (filtered.length === 0) {
      tableWrap.innerHTML = "<div class='no-data'>æ³¨æ–‡ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Šã¾ã›ã‚“ã€‚</div>";
      return;
    }

    const rowsHtml = filtered.map(order => {
      const created = order.createdAt?.toDate
        ? order.createdAt.toDate()
        : null;
      const dateStr = created
        ? `${created.getMonth() + 1}/${created.getDate()} ${String(created.getHours()).padStart(2,"0")}:${String(created.getMinutes()).padStart(2,"0")}`
        : "-";

      const itemsHtml = (order.items || []).map(it => {
        return `<li>${it.name} Ã— ${it.qty}ï¼ˆÂ¥${it.price}ï¼‰</li>`;
      }).join("");

      const total = order.total ?? 0;

      const statusBadgeClass =
        order.status === "new"       ? "status-new" :
        order.status === "preparing" ? "status-preparing" :
        order.status === "ready"     ? "status-ready" :
        order.status === "done"      ? "status-done" : "";

      return `
        <tr data-id="${order.id}">
          <td>
            <div>${dateStr}</div>
            <div class="order-id">${order.id}</div>
          </td>
          <td>
            ${order.customerName || "-"}<br>
            <span style="font-size:11px;color:#666;">${order.tel || ""}</span>
          </td>
          <td>${order.pickupTime || "-"}</td>
          <td>
            <ul class="items-list">
              ${itemsHtml}
            </ul>
          </td>
          <td>Â¥${total}</td>
          <td>
            <select class="status-select">
              <option value="new"       ${order.status === "new"       ? "selected" : ""}>new</option>
              <option value="preparing" ${order.status === "preparing" ? "selected" : ""}>preparing</option>
              <option value="ready"     ${order.status === "ready"     ? "selected" : ""}>ready</option>
              <option value="done"      ${order.status === "done"      ? "selected" : ""}>done</option>
            </select>
            <div class="status-badge ${statusBadgeClass}">
              ${order.status || "-"}
            </div>
          </td>
        </tr>
      `;
    }).join("");

    tableWrap.innerHTML = `
      <table>
        <thead>
          <tr>
            <th>æ™‚é–“ / æ³¨æ–‡ID</th>
            <th>ãŠå®¢æ§˜</th>
            <th>å—ã‘å–ã‚Šæ™‚é–“</th>
            <th>å†…å®¹</th>
            <th>åˆè¨ˆ</th>
            <th>ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹</th>
          </tr>
        </thead>
        <tbody>
          ${rowsHtml}
        </tbody>
      </table>
    `;

    // ã‚»ãƒ¬ã‚¯ãƒˆã«ã‚¤ãƒ™ãƒ³ãƒˆã‚’ä»˜ã‘ã‚‹
    tableWrap.querySelectorAll(".status-select").forEach(select => {
      select.addEventListener("change", async () => {
        const tr = select.closest("tr");
        const id = tr.dataset.id;
        const newStatus = select.value;

        try {
          // Firestore æ›´æ–°ã¯å…±é€šé–¢æ•°ã«ãŠã¾ã‹ã›
          await updateStatus(id, newStatus);

          // ãƒ¡ãƒ¢ãƒªä¸Šã®ãƒ‡ãƒ¼ã‚¿ã‚‚æ›´æ–°
          const target = allOrders.find(o => o.id === id);
          if (target) target.status = newStatus;

          // ãƒãƒƒã‚¸ã®è¡¨ç¤ºæ›´æ–°
          const badge = tr.querySelector(".status-badge");
          badge.textContent = newStatus;
          badge.className = "status-badge " +
            (newStatus === "new"       ? "status-new" :
             newStatus === "preparing" ? "status-preparing" :
             newStatus === "ready"     ? "status-ready" :
             newStatus === "done"      ? "status-done" : "");

        } catch (err) {
          console.error("ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹æ›´æ–°ã‚¨ãƒ©ãƒ¼:", err);
          alert("ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ã®æ›´æ–°ã«å¤±æ•—ã—ã¾ã—ãŸã€‚");
        }
      });
    });
  }

  // ========== å•†å“ãƒã‚¹ã‚¿ï¼šèª­ã¿è¾¼ã¿ ==========
  async function loadItems() {
    itemsTableWrap.innerHTML = "<div class='no-data'>èª­ã¿è¾¼ã¿ä¸­...</div>";
    try {
      const snap = await getDocs(collection(db, "items"));
      allItems = snap.docs.map(docSnap => ({
        id: docSnap.id,
        ...docSnap.data()
      }));
      renderItemsTable();
    } catch (err) {
      console.error("items èª­ã¿è¾¼ã¿ã‚¨ãƒ©ãƒ¼:", err);
      itemsTableWrap.innerHTML = "<div class='no-data'>èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸã€‚</div>";
    }
  }

  // ========== å•†å“ãƒã‚¹ã‚¿ï¼šãƒ†ãƒ¼ãƒ–ãƒ«æç”» ==========
  function renderItemsTable() {
    if (!allItems.length) {
      itemsTableWrap.innerHTML = "<div class='no-data'>å•†å“ãŒç™»éŒ²ã•ã‚Œã¦ã„ã¾ã›ã‚“ã€‚</div>";
      return;
    }

    const rowsHtml = allItems.map(item => `
      <tr data-id="${item.id}">
        <td>${item.name || "-"}</td>
        <td>Â¥${(item.price ?? 0).toLocaleString()}</td>
        <td>${item.category || "-"}</td>
        <td>
          <button class="danger-btn item-delete-btn" data-id="${item.id}">å‰Šé™¤</button>
        </td>
      </tr>
    `).join("");

    itemsTableWrap.innerHTML = `
      <table>
        <thead>
          <tr>
            <th>å•†å“å</th>
            <th>ä¾¡æ ¼</th>
            <th>ã‚«ãƒ†ã‚´ãƒª</th>
            <th></th>
          </tr>
        </thead>
        <tbody>
          ${rowsHtml}
        </tbody>
      </table>
    `;

    // å‰Šé™¤ãƒœã‚¿ãƒ³ã®ã‚¤ãƒ™ãƒ³ãƒˆ
    itemsTableWrap.querySelectorAll(".item-delete-btn").forEach(btn => {
      btn.addEventListener("click", async () => {
        const id = btn.dataset.id;
        if (!confirm("ã“ã®å•†å“ã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ")) return;

        try {
          await deleteDoc(doc(db, "items", id));
          allItems = allItems.filter(i => i.id !== id);
          renderItemsTable();
        } catch (err) {
          console.error("å•†å“å‰Šé™¤ã‚¨ãƒ©ãƒ¼:", err);
          alert("å•†å“ã®å‰Šé™¤ã«å¤±æ•—ã—ã¾ã—ãŸã€‚");
        }
      });
    });
  }

  // ========== ã‚¤ãƒ™ãƒ³ãƒˆ ==========
  // æ³¨æ–‡å´
  reloadBtn.addEventListener("click", loadOrders);
  filterButtons.forEach(btn => {
    btn.addEventListener("click", () => {
      filterButtons.forEach(b => b.classList.remove("active"));
      btn.classList.add("active");
      currentFilter = btn.dataset.status;
      renderTable();
    });
  });

  // ã‚¿ãƒ–åˆ‡ã‚Šæ›¿ãˆ
  tabOrders.addEventListener("click", () => {
    tabOrders.classList.add("active");
    tabItems.classList.remove("active");
    ordersSection.classList.remove("hidden");
    itemsSection.classList.add("hidden");
  });

  tabItems.addEventListener("click", () => {
    tabItems.classList.add("active");
    tabOrders.classList.remove("active");
    ordersSection.classList.add("hidden");
    itemsSection.classList.remove("hidden");
    loadItems(); // å•†å“ã‚¿ãƒ–ã‚’é–‹ã„ãŸã‚¿ã‚¤ãƒŸãƒ³ã‚°ã§èª­ã¿è¾¼ã¿
  });

  // å•†å“ãƒã‚¹ã‚¿ï¼šæ›´æ–°ãƒœã‚¿ãƒ³
  reloadItemsBtn.addEventListener("click", loadItems);

  // å•†å“è¿½åŠ ãƒ•ã‚©ãƒ¼ãƒ 
  itemForm.addEventListener("submit", async (e) => {
    e.preventDefault();
    const name     = itemNameInput.value.trim();
    const price    = Number(itemPriceInput.value);
    const category = itemCategorySelect.value;

    if (!name || !price || !category) {
      alert("å•†å“åãƒ»ä¾¡æ ¼ãƒ»ã‚«ãƒ†ã‚´ãƒªã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚");
      return;
    }

    try {
      await addDoc(collection(db, "items"), {
        name,
        price,
        category
      });
      itemForm.reset();
      loadItems();
    } catch (err) {
      console.error("å•†å“è¿½åŠ ã‚¨ãƒ©ãƒ¼:", err);
      alert("å•†å“ã®è¿½åŠ ã«å¤±æ•—ã—ã¾ã—ãŸã€‚");
    }
  });

  // åˆå›èª­ã¿è¾¼ã¿
  loadOrders();
  </script>

</body>
</html>
